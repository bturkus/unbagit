#!/bin/bash
# digital preservation got you down?
# cleanse your repository packages of bagit files with this script
# it will remove files generated by bagit, move contents of the data directory up a level and remove the data directory, basically the reverse of the baginplace function
# save bytes and bytes of data
version=0.0.0.1

usage(){
    echo
    echo "$(basename ${0}) version ${version}"
    echo
    echo "Description: $(basename ${0}) saves so much digital space by cleaning out all bagit files. It's basically undoes the effects of the bagit baginplace function. Warning $(basename ${0}) is intended only for UNtrusted digital repositories."
    echo
    echo "Usage: $(basename ${0}) BAGIT_PACKAGE"
    echo
exit
}
[ "${#}" = 0 ] && usage

PACKAGE="$1"
if [ ! -d "$PACKAGE/data" ] ; then
    echo "Excuse me, $(basename $PACKAGE) does not appear to be a BAG. What you doing?"
    exit 1
fi
if [ ! -f "$PACKAGE/bagit.txt" ] ; then
    echo "Excuse me, $PACKAGE does not appear to be a BAG. What you doing?"
    exit 1
fi
spacesave=$(du -ch "$PACKAGE/bag-info.txt" "$PACKAGE/bagit.txt" "$PACKAGE/manifest-md5.txt" "$PACKAGE/tagmanifest-md5.txt" | tail -1 | awk '{print $1}')
echo
echo "Removing bagit files...."
rm -v "$PACKAGE/bag-info.txt" "$PACKAGE/bagit.txt" "$PACKAGE/manifest-md5.txt" "$PACKAGE/tagmanifest-md5.txt"
echo
echo "Moving files...."
find "$PACKAGE/data" -mindepth 1 -maxdepth 1 -exec mv -v -n "{}" "$PACKAGE" \;
echo
echo "Tossing that bagit data folder"
rmdir "$PACKAGE/data"
echo
echo "Congratulations, you saved $spacesave of data"